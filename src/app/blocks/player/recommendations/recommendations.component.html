<!-- Recommendations Section -->
<div
  [ngClass]="{
    'bg-white dark:bg-zinc-900': isExpanded,
    'bg-transparent': !isExpanded,
    'rounded-2xl flex flex-col': true
  }"
  [style.height.px]="isExpanded ? panelHeight : null"
  class="w-[98vw] sm:w-[95vw] md:w-[90vw] lg:w-[600px] xl:w-[700px] 2xl:w-[800px] max-w-full mx-auto min-w-0 shadow-md"
>
  <!-- Header -->
  <div
    *ngIf="!hideHeader"
    [ngClass]="{
      'flex items-center justify-between transition-all flex-shrink-0': true,
      'cursor-pointer': mediaType !== 'movie',
      'rounded-t-2xl': isExpanded,
      'rounded-2xl': !isExpanded,
      'border-b border-gray-100 dark:border-zinc-800': isExpanded,
      'px-3 py-2.5 sm:px-4 sm:py-3': true
    }"
    (click)="mediaType !== 'movie' ? toggleExpansion() : null"
    style="background: inherit"
  >
    <div class="flex items-center gap-2 sm:gap-3 min-w-0">
      <div
        class="flex items-center justify-center w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-blue-500/10 flex-shrink-0"
      >
        <svg
          class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-blue-600 dark:text-blue-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"
          ></path>
        </svg>
      </div>
      <div class="min-w-0 flex-1">
        <h2
          class="text-sm sm:text-base font-medium text-gray-900 dark:text-gray-100 truncate"
        >
          Recommendations
        </h2>
        <p
          class="text-[11px] sm:text-xs text-gray-600 dark:text-gray-400 truncate"
        >
          <ng-container *ngIf="recommendations.length > 0; else noRec">
            {{ recommendations.length }} suggestion{{
              recommendations.length !== 1 ? "s" : ""
            }}
          </ng-container>
          <ng-template #noRec>No recommendations</ng-template>
        </p>
      </div>
    </div>
    <button
      *ngIf="mediaType !== 'movie'"
      class="flex items-center justify-center w-7 h-7 sm:w-8 sm:h-8 rounded-full hover:bg-gray-100 dark:hover:bg-zinc-800 transition-colors flex-shrink-0"
      [attr.aria-label]="isExpanded ? 'Collapse' : 'Expand'"
    >
      <svg
        class="w-4 h-4 text-gray-600 dark:text-gray-400 transition-transform duration-300"
        [class.rotate-180]="isExpanded"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M19 9l-7 7-7-7"
        ></path>
      </svg>
    </button>
  </div>

  <!-- Content -->
  <div
    *ngIf="isExpanded"
    class="overflow-y-auto flex-1 min-h-0 scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-zinc-700 scrollbar-track-transparent"
    [ngClass]="{ 'px-2 py-1.5 sm:px-3 sm:py-2': true }"
  >
    <!-- Loading State -->
    <div
      *ngIf="isLoading"
      class="flex flex-col items-center justify-center py-10 sm:py-12"
    >
      <div class="relative">
        <div
          class="w-8 h-8 sm:w-10 sm:h-10 rounded-full border-3 border-gray-200 dark:border-zinc-700"
        ></div>
        <div
          class="w-8 h-8 sm:w-10 sm:h-10 rounded-full border-3 border-blue-600 dark:border-blue-400 border-t-transparent animate-spin absolute top-0 left-0"
        ></div>
      </div>
      <p
        class="mt-2 sm:mt-3 text-[11px] sm:text-xs text-gray-600 dark:text-gray-400"
      >
        Loading...
      </p>
    </div>

    <!-- Error State -->
    <div
      *ngIf="error && !isLoading"
      class="flex items-center justify-center py-10 sm:py-12 px-4"
    >
      <div class="flex items-center gap-2">
        <div
          class="w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-red-50 dark:bg-red-900/20 flex items-center justify-center flex-shrink-0"
        >
          <svg
            class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-red-600 dark:text-red-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
        </div>
        <p
          class="text-[11px] sm:text-xs text-red-600 dark:text-red-400 break-words"
        >
          {{ error }}
        </p>
      </div>
    </div>

    <!-- Recommendations List -->
    <div
      *ngIf="!isLoading && !error && recommendations.length > 0"
      class="flex flex-col gap-1.5 sm:gap-2"
    >
      <div
        *ngFor="let item of recommendations; trackBy: trackByFn"
        class="group bg-white dark:bg-zinc-800 rounded-lg shadow-sm hover:shadow-md transition-all duration-300 overflow-hidden border border-gray-100 dark:border-zinc-700 hover:border-blue-200 dark:hover:border-blue-800"
      >
        <!-- Main Content -->
        <div
          class="flex gap-2 sm:gap-3 p-2 sm:p-2.5 cursor-pointer"
          (click)="navigateToItem(item)"
        >
          <!-- Poster -->
          <div
            class="relative flex-shrink-0 w-10 h-15 sm:w-12 sm:h-18 rounded overflow-hidden shadow-sm"
          >
            <img
              [src]="
                item.poster_path
                  ? 'https://image.tmdb.org/t/p/w154' + item.poster_path
                  : './assets/placeholder.png'
              "
              [alt]="getDisplayTitle(item) + ' Poster'"
              loading="lazy"
              class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
            />
          </div>

          <!-- Info -->
          <div
            class="flex-1 min-w-0 flex flex-col justify-center gap-0.5 sm:gap-1"
          >
            <h3
              class="font-medium text-gray-900 dark:text-gray-100 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors leading-tight"
              [ngClass]="{
                'text-xs sm:text-sm': true,
                truncate: !isItemExpanded(item.id),
                'line-clamp-2': !isItemExpanded(item.id)
              }"
            >
              {{ getDisplayTitle(item) }}
            </h3>

            <!-- Meta Row -->
            <div
              class="flex items-center gap-1 sm:gap-1.5 text-gray-600 dark:text-gray-400 flex-wrap"
            >
              <!-- Rating -->
              <div
                *ngIf="item.vote_average > 0"
                class="flex items-center gap-0.5 flex-shrink-0"
              >
                <svg
                  class="w-2.5 h-2.5 sm:w-3 sm:h-3 text-amber-400 flex-shrink-0"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
                  />
                </svg>
                <span class="font-medium text-[10px] sm:text-[11px]">{{
                  item.vote_average.toFixed(1)
                }}</span>
              </div>

              <span
                *ngIf="
                  item.vote_average > 0 &&
                  (getYear(item) || (item.genres && item.genres.length > 0))
                "
                class="text-gray-300 dark:text-gray-600 text-[10px] sm:text-xs"
                >•</span
              >

              <!-- Year -->
              <span
                *ngIf="getYear(item)"
                class="text-[10px] sm:text-[11px] flex-shrink-0"
                >{{ getYear(item) }}</span
              >

              <span
                *ngIf="getYear(item) && item.genres && item.genres.length > 0"
                class="text-gray-300 dark:text-gray-600 text-[10px] sm:text-xs hidden sm:inline"
                >•</span
              >

              <!-- Genre -->
              <span
                *ngIf="item.genres && item.genres.length > 0"
                class="text-[10px] sm:text-[11px] truncate min-w-0 hidden sm:inline"
                >{{ item.genres[0] }}</span
              >
            </div>
          </div>

          <!-- Expand Button -->
          <button
            (click)="$event.stopPropagation(); toggleItemExpansion(item.id)"
            class="flex-shrink-0 self-center w-6 h-6 sm:w-7 sm:h-7 rounded-full hover:bg-gray-100 dark:hover:bg-zinc-700 flex items-center justify-center transition-colors"
            [attr.aria-label]="
              isItemExpanded(item.id) ? 'Show less' : 'Show more'
            "
          >
            <svg
              class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-gray-500 dark:text-gray-400 transition-transform duration-300"
              [class.rotate-180]="isItemExpanded(item.id)"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"
              ></path>
            </svg>
          </button>
        </div>

        <!-- Expanded Details -->
        <div
          *ngIf="isItemExpanded(item.id)"
          class="px-2 pb-2 sm:px-2.5 sm:pb-2.5 pt-0 border-t border-gray-100 dark:border-zinc-700 animate-fadeIn"
        >
          <!-- Genres Pills -->
          <div
            *ngIf="item.genres && item.genres.length > 0"
            class="flex flex-wrap gap-1 sm:gap-1.5 mb-1.5 sm:mb-2 mt-1.5 sm:mt-2"
          >
            <span
              *ngFor="let genre of item.genres; let i = index"
              class="inline-flex items-center px-1.5 sm:px-2 py-0.5 rounded-full text-[10px] sm:text-[11px] font-medium bg-gray-100 dark:bg-zinc-700 text-gray-700 dark:text-gray-300"
            >
              {{ genre }}
            </span>
          </div>

          <!-- Overview -->
          <div *ngIf="item.overview" class="mt-1.5 sm:mt-2">
            <p
              class="text-[11px] sm:text-xs text-gray-600 dark:text-gray-400 leading-relaxed"
              [class.line-clamp-3]="!isDescriptionExpanded(item.id)"
            >
              {{ item.overview }}
            </p>
            <button
              *ngIf="item.overview.length > 120"
              (click)="toggleDescription(item.id)"
              class="mt-1 sm:mt-1.5 text-[11px] sm:text-xs text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 font-medium transition-colors"
            >
              {{ isDescriptionExpanded(item.id) ? "Less" : "More" }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div
      *ngIf="!isLoading && !error && recommendations.length === 0"
      class="flex flex-col items-center justify-center py-10 sm:py-12 px-4"
    >
      <div
        class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-gray-100 dark:bg-zinc-800 flex items-center justify-center mb-2 sm:mb-3"
      >
        <svg
          class="w-5 h-5 sm:w-6 sm:h-6 text-gray-400 dark:text-gray-600"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"
          ></path>
        </svg>
      </div>
      <p
        class="text-[11px] sm:text-xs text-gray-500 dark:text-gray-400 font-medium text-center"
      >
        No recommendations available
      </p>
    </div>
  </div>
</div>
