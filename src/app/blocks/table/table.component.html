<div class="font-[sans-serif] flex flex-col min-h-screen">
  <div class="flex-1 p-3 sm:p-4 w-full max-w-7xl mx-auto pb-24">
    <!-- pb-24 for save bar -->
   <!-- Top Action Bar -->
<div class="mb-4 p-3 bg-white dark:bg-zinc-900 rounded-lg border border-gray-200 dark:border-zinc-700 shadow-sm">
  <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
    
    <!-- Left: Search -->
    <div class="flex-grow lg:max-w-md">
      <div class="relative">
        <app-icon-lib
          ico="search"
          class="absolute left-2 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400 dark:text-gray-500"
        ></app-icon-lib>
        <input
          type="search"
          class="w-full px-4 py-2.5 pl-10 pr-4 border border-gray-300 dark:border-zinc-600 bg-gray-50 dark:bg-zinc-800 rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-600 focus:border-transparent focus:bg-white dark:focus:bg-zinc-800 transition-all text-sm text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400"
          placeholder="Filter sources..."
          [(ngModel)]="searchInput"
        />
      </div>
    </div>

    <!-- Right: Action Buttons -->
    <div class="flex flex-wrap items-center gap-2">
      
      <!-- Conditional Actions for Selected Items -->
      <ng-container *ngIf="anyRowsSelected()">
        <button
          type="button"
          (click)="toggleBulkEditSelected()"
          class="px-4 py-2 text-sm font-medium rounded-lg border flex items-center gap-2 transition-all hover:shadow-md focus:outline-none focus:ring-2"
          [ngClass]="{
            'bg-white dark:bg-zinc-800 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-zinc-700 border-gray-300 dark:border-zinc-600 focus:ring-gray-300':
              !isBulkEditingSelected,
            'bg-blue-600 text-white hover:bg-blue-700 border-blue-600 focus:ring-blue-300':
              isBulkEditingSelected
          }"
        >
          <app-icon-lib
            [ico]="isBulkEditingSelected ? 'check' : 'edit'"
            class="h-4 w-4"
          ></app-icon-lib>
          {{ isBulkEditingSelected ? "Done" : "Edit Selected" }}
        </button>

        <button
          type="button"
          (click)="deleteSelectedSources()"
          class="px-4 py-2 text-sm font-medium rounded-lg border flex items-center gap-2 transition-all bg-white dark:bg-zinc-800 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 border-gray-300 dark:border-zinc-600 hover:border-red-300 dark:hover:border-red-800 focus:outline-none focus:ring-2 focus:ring-red-300 hover:shadow-md"
        >
          <app-icon-lib ico="trash" class="h-4 w-4"></app-icon-lib>
          Delete Selected
        </button>

        <div class="w-px h-6 bg-gray-300 dark:bg-zinc-600 mx-1"></div>
      </ng-container>

      <!-- Main Actions -->
      <button
        type="button"
        (click)="editAllSources()"
        class="px-4 py-2 text-sm font-medium rounded-lg border flex items-center gap-2 transition-all bg-white dark:bg-zinc-800 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-zinc-700 border-gray-300 dark:border-zinc-600 focus:outline-none focus:ring-2 focus:ring-gray-300 hover:shadow-md"
        [ngClass]="{
          'bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 border-blue-300 dark:border-blue-700': isEditingAllVisible
        }"
      >
        <app-icon-lib ico="edit" class="h-4 w-4"></app-icon-lib>
        <span class="hidden sm:inline">{{ isEditingAllVisible ? "Done Editing" : "Edit All" }}</span>
      </button>

      <button
        type="button"
        (click)="isImportModalOpen = true"
        class="px-4 py-2 text-sm font-medium rounded-lg border flex items-center gap-2 transition-all bg-white dark:bg-zinc-800 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-zinc-700 border-gray-300 dark:border-zinc-600 focus:outline-none focus:ring-2 focus:ring-gray-300 hover:shadow-md"
      >
        <app-icon-lib ico="upload" class="h-4 w-4"></app-icon-lib>
        <span class="hidden sm:inline">Import</span>
      </button>

      <button
        type="button"
        (click)="isExportModalOpen = true"
        class="px-4 py-2 text-sm font-medium rounded-lg border flex items-center gap-2 transition-all bg-white dark:bg-zinc-800 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-zinc-700 border-gray-300 dark:border-zinc-600 focus:outline-none focus:ring-2 focus:ring-gray-300 hover:shadow-md"
      >
        <app-icon-lib ico="download" class="h-4 w-4"></app-icon-lib>
        <span class="hidden sm:inline">Export</span>
      </button>

      <div class="w-px h-6 bg-gray-300 dark:bg-zinc-600 mx-1"></div>

      <!-- More Menu (Only destructive/advanced actions) -->
      <div class="relative">
        <button
          type="button"
          (click)="toggleMenu($event)"
          class="p-2 text-sm font-medium rounded-lg border flex items-center gap-1 transition-all bg-white dark:bg-zinc-800 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-zinc-700 border-gray-300 dark:border-zinc-600 focus:outline-none focus:ring-2 focus:ring-gray-300 hover:shadow-md"
          [class.bg-gray-100]="isMenuOpen"
          [class.dark:bg-zinc-700]="isMenuOpen"
        >
          <app-icon-lib ico="dotsVertical" class="h-5 w-5"></app-icon-lib>
        </button>

        <!-- Dropdown Menu -->
        <div
          *ngIf="isMenuOpen"
          (clickOutside)="closeMenuOutside()"
          class="absolute right-0 mt-2 w-64 bg-white dark:bg-zinc-800 border border-gray-200 dark:border-zinc-700 rounded-xl shadow-lg z-20 overflow-hidden"
        >
          <div class="py-2">
            <!-- Subscription Status & Action -->
            <div class="px-4 py-2 border-b border-gray-100 dark:border-zinc-700">
              <div class="flex items-center justify-between mb-2">
                <span class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">
                  Capi Sources
                </span>
                <span 
                  class="text-xs px-2 py-0.5 rounded-full"
                  [ngClass]="{
                    'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400': isSubscribed,
                    'bg-gray-100 dark:bg-zinc-700 text-gray-600 dark:text-gray-400': !isSubscribed
                  }"
                >
                  {{ isSubscribed ? 'Subscribed' : 'Not subscribed' }}
                </span>
              </div>
              <button
                type="button"
                (click)="isSubscribed ? unsubscribeFromDefaultSources() : subscribeToDefaultSources(); closeMenuOutside()"
                class="w-full px-3 py-2 text-sm font-medium rounded-lg transition-colors flex items-center gap-2"
                [ngClass]="{
                  'bg-blue-600 hover:bg-blue-700 text-white': !isSubscribed,
                  'bg-gray-100 dark:bg-zinc-700 hover:bg-gray-200 dark:hover:bg-zinc-600 text-gray-700 dark:text-gray-200': isSubscribed
                }"
              >
                <app-icon-lib 
                  [ico]="isSubscribed ? 'x' : 'sync'" 
                  class="h-4 w-4"
                ></app-icon-lib>
                {{ isSubscribed ? 'Unsubscribe' : 'Subscribe' }}
              </button>
            </div>

            <a
              [routerLink]="['/table/docs']"
              (click)="closeMenuOutside()"
              class="flex items-start px-4 py-3 text-sm hover:bg-gray-50 dark:hover:bg-zinc-700/50 cursor-pointer transition-colors"
            >
              <app-icon-lib ico="book" class="h-5 w-5  mr-3 mt-0.5"></app-icon-lib>
              <div>
                <div class="font-medium text-gray-900 dark:text-gray-100">Documentation</div>
                <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
                  Learn how to manage sources
                </div>
              </div>
            </a>

            <a
              (click)="removeIsNewcomerFromLocalStorage(); closeMenuOutside()"
              class="flex items-center px-4 py-2.5 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-zinc-700/50 cursor-pointer transition-colors"
            >
              <app-icon-lib ico="refresh" class="h-4 w-4 mr-3"></app-icon-lib>
              Reset to Default Data
            </a>

            <div class="my-1 border-t border-gray-100 dark:border-zinc-700"></div>

            <a
              (click)="isUniversalOpenDelete = true; closeMenuOutside()"
              class="flex items-center px-4 py-2.5 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 cursor-pointer transition-colors"
            >
              <app-icon-lib ico="trash" class="h-4 w-4 mr-3"></app-icon-lib>
              Delete All Sources
            </a>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

    <!-- Add New Source Form (Google Material Style - Mobile Responsive) -->
<div class="mb-6">
  <!-- Collapsed State - Add Button -->
  <div
    *ngIf="!isAdding"
    class="group w-full bg-white dark:bg-zinc-800 rounded-lg shadow-sm hover:shadow-md transition-all duration-200 cursor-pointer overflow-hidden"
    (click)="startAdd()"
    role="button"
    tabindex="0"
    aria-label="Add new source"
  >
    <div class="flex items-center px-4 sm:px-6 py-3 sm:py-4">
      <div class="flex items-center gap-3 text-gray-600 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
        <app-icon-lib
          ico="plus"
          class="h-5 w-5"
        ></app-icon-lib>
        <span class="text-sm font-medium">Add new source</span>
      </div>
    </div>
  </div>

  <!-- Expanded State - Form -->
  <div
    *ngIf="isAdding"
    class="bg-white dark:bg-zinc-800 rounded-lg shadow-md"
  >
    <!-- Header -->
    <div class="px-4 sm:px-6 pt-4 sm:pt-5 pb-3 sm:pb-4 border-b border-gray-100 dark:border-zinc-700">
      <h3 class="text-base font-medium text-gray-900 dark:text-gray-100">
        Add new source
      </h3>
    </div>

    <!-- Form Content -->
    <div class="px-4 sm:px-6 py-4 sm:py-5 space-y-4">
      <!-- Name Input -->
      <div class="w-full">
        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1.5">
          Name <span class="text-gray-400 font-normal">(optional)</span>
        </label>
        <input
          type="text"
          class="w-full px-3 py-2.5 text-sm bg-gray-50 dark:bg-zinc-900 border border-gray-200 dark:border-zinc-700 rounded-lg text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:bg-white dark:focus:bg-zinc-800 focus:border-blue-500 dark:focus:border-blue-500 focus:ring-2 focus:ring-blue-50 dark:focus:ring-blue-900/50 transition-all"
          placeholder="Enter source name"
          [(ngModel)]="newName"
          (keyup.enter)="confirmAdd()"
        />
      </div>

      <!-- URL Input -->
      <div class="w-full">
        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1.5">
          URL
        </label>
        <input
          type="text"
          class="w-full px-3 py-2.5 text-sm bg-gray-50 dark:bg-zinc-900 border border-gray-200 dark:border-zinc-700 rounded-lg text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:bg-white dark:focus:bg-zinc-800 focus:border-blue-500 dark:focus:border-blue-500 focus:ring-2 focus:ring-blue-50 dark:focus:ring-blue-900/50 transition-all"
          placeholder="https://example.com/#season:number/#episode:number"
          [(ngModel)]="newUrl"
          (keyup.enter)="confirmAdd()"
        />
        <p class="mt-1.5 text-xs text-gray-500 dark:text-gray-400">
          Use #season:number, #episode:number, #id:tmdbID, #type:tv/movie as placeholders
        </p>
      </div>
    </div>

    <!-- Actions Footer - RESPONSIVE -->
    <div class="px-4 sm:px-6 py-3 sm:py-4 bg-gray-50 dark:bg-zinc-900/50 rounded-b-lg">
      <!-- Mobile: Stack vertically -->
      <div class="flex flex-col sm:hidden gap-2">
        <div class="flex gap-2">
          <button
            type="button"
            class="flex-1 px-4 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-zinc-800 hover:bg-gray-100 dark:hover:bg-zinc-700 border border-gray-200 dark:border-zinc-700 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600"
            (click)="cancelAdd()"
            aria-label="Cancel adding source"
          >
            Cancel
          </button>
          <button
            type="button"
            class="flex-1 px-4 py-2.5 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 dark:bg-blue-600 dark:hover:bg-blue-700 rounded-lg shadow-sm hover:shadow transition-all focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
            (click)="confirmAdd()"
            [disabled]="!newUrl.trim()"
            aria-label="Confirm add source"
          >
            Add source
          </button>
        </div>
        <button
          type="button"
          class="w-full inline-flex items-center justify-center gap-2 px-4 py-2.5 text-sm font-medium text-purple-700 dark:text-purple-400 bg-purple-50 dark:bg-purple-900/30 hover:bg-purple-100 dark:hover:bg-purple-900/50 border border-purple-100 dark:border-purple-900/50 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-purple-500"
          (click)="openAdvancedSourceModal(); cancelAdd()"
          title="Open Advanced Source Editor"
          aria-label="Open Advanced Source Editor"
        >
          <app-icon-lib ico="maximize" class="h-4 w-4"></app-icon-lib>
          <span>Advanced Editor</span>
        </button>
      </div>

      <!-- Desktop: Horizontal layout -->
      <div class="hidden sm:flex items-center justify-between gap-3">
        <!-- Advanced Button (Left) -->
        <button
          type="button"
          class="inline-flex items-center gap-2 px-3.5 py-2 text-sm font-medium text-purple-700 dark:text-purple-400 bg-purple-50 dark:bg-purple-900/30 hover:bg-purple-100 dark:hover:bg-purple-900/50 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 dark:focus:ring-offset-zinc-800"
          (click)="openAdvancedSourceModal(); cancelAdd()"
          title="Open Advanced Source Editor"
          aria-label="Open Advanced Source Editor"
        >
          <app-icon-lib ico="maximize" class="h-4 w-4"></app-icon-lib>
          <span>Advanced</span>
        </button>

        <!-- Right Actions -->
        <div class="flex items-center gap-2">
          <button
            type="button"
            class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-800 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600"
            (click)="cancelAdd()"
            aria-label="Cancel adding source"
          >
            Cancel
          </button>
          <button
            type="button"
            class="px-5 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 dark:bg-blue-600 dark:hover:bg-blue-700 rounded-lg shadow-sm hover:shadow transition-all focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-zinc-800 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:shadow-sm"
            (click)="confirmAdd()"
            [disabled]="!newUrl.trim()"
            aria-label="Confirm add source"
          >
            Add source
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

    <!-- Table Container -->
    <div
      class="rounded-lg border border-gray-200 dark:border-zinc-700 overflow-x-auto"
    >
      <!-- Added overflow-x-auto for safety on very small screens if table content still too wide -->
      <table class="w-full bg-white dark:bg-zinc-900 table-auto">
        <thead
          class="bg-gray-100 dark:bg-zinc-800 text-gray-600 dark:text-gray-300 hidden lg:table-header-group"
        >
          <tr class="align-middle">
            <th scope="col" class="p-3 w-10"></th>
            <th scope="col" class="p-3 w-12 text-center">
              <input
                type="checkbox"
                class="w-5 h-5 text-blue-600 border-gray-300 dark:border-zinc-600 rounded focus:ring-offset-0 focus:ring-2 focus:ring-blue-400 dark:focus:ring-blue-700"
                aria-label="Select all sources"
                [(ngModel)]="isAllSelected"
                (ngModelChange)="toggleSelectAll()"
                [disabled]="searchInObject().length === 0"
              />
            </th>
            <th
              scope="col"
              class="p-3 text-left text-sm font-semibold min-w-[150px]"
            >
              Name
            </th>
            <th
              scope="col"
              class="p-3 text-left text-sm font-semibold hidden lg:table-cell min-w-[200px]"
            >
              URL
            </th>
            <th scope="col" class="p-3 text-center text-sm font-semibold w-24">
              Active
            </th>
            <th scope="col" class="p-3 text-right text-sm font-semibold w-32">
              Actions
            </th>
          </tr>
        </thead>
        <tbody
          cdkDropList
          (cdkDropListDropped)="onDrop($event)"
          class="lg:divide-y lg:divide-gray-200 dark:lg:divide-gray-700"
        >
          <ng-container
            *ngIf="searchInObject().length > 0; else noResultsOrEmpty"
          >
            <tr
              *ngFor="let source of searchInObject(); trackBy: trackById"
              cdkDrag
              [cdkDragData]="source"
              class="hover:bg-gray-50 dark:hover:bg-zinc-800 border-b lg:border-b-0 border-gray-200 dark:border-zinc-700"
              [class.bg-blue-50]="
                source.selected && !isBulkEditingSelected && !source.isEditing
              "
              [class.dark:bg-blue-900]="
                source.selected && !isBulkEditingSelected && !source.isEditing
              "
              [class.opacity-75]="source.isEditing && !isBulkEditingSelected"
              [class.bg-yellow-50]="
                source.isEditing && isBulkEditingSelected && source.selected
              "
              [class.dark\:bg-yellow-900]="
                source.isEditing && isBulkEditingSelected && source.selected
              "
            >
              <!-- Mobile View: Single TD card-like layout -->
              <td class="p-2 lg:hidden">
                <div class="flex gap-2 w-full">
                  <div
                    class="flex flex-col items-center gap-2 pt-1 flex-shrink-0"
                  >
                    <input
                      type="checkbox"
                      class="w-5 h-5 text-blue-600 border-gray-300 dark:border-zinc-600 rounded focus:ring-offset-0 focus:ring-1 focus:ring-blue-400 dark:focus:ring-blue-700"
                      [attr.aria-label]="
                        'Select source ' +
                        (source.name || getDisplayName(source))
                      "
                      [(ngModel)]="source.selected"
                      (ngModelChange)="onRowSelectionChange()"
                      (click)="$event.stopPropagation()"
                    />
                    <div
                      cdkDragHandle
                      class="cursor-move p-1 text-gray-400 dark:text-gray-500 hover:text-gray-500 dark:hover:text-gray-300 rounded-md"
                    >
                      <app-icon-lib ico="menu" class="h-5 w-5"></app-icon-lib>
                    </div>
                  </div>
                  <div class="flex flex-col gap-1.5 flex-1 min-w-0">
                    <div class="flex items-start gap-2">
                      <img
                        src="https://www.google.com/s2/favicons?sz=32&domain_url={{
                          getDisplayName(source)
                        }}"
                        class="w-6 h-6 mt-0.5 rounded-full flex-shrink-0 object-contain border border-gray-100 dark:border-zinc-700"
                        alt="Favicon"
                        loading="lazy"
                      />
                      <div class="flex-1 min-w-0">
                        <div
                          *ngIf="!source.isEditing"
                          class="text-sm font-medium text-gray-800 dark:text-gray-100 break-words"
                        >
                          {{ source.name || getDisplayName(source) }}
                        </div>
                        <input
                          *ngIf="source.isEditing"
                          type="text"
                          class="border border-gray-300 dark:border-zinc-600 rounded-md px-2 py-1 w-full text-sm bg-white dark:bg-zinc-800 text-gray-900 dark:text-gray-100 focus:border-blue-500 dark:focus:border-blue-400 focus:ring-1 focus:ring-blue-500 dark:focus:ring-blue-400"
                          placeholder="Name"
                          [(ngModel)]="source.name"
                          (keyup.enter)="editSource(source)"
                          (click)="$event.stopPropagation()"
                        />
                      </div>
                    </div>
                    <div class="min-w-0">
                      <div
                        *ngIf="!source.isEditing"
                        class="text-xs text-gray-600 dark:text-gray-400 break-all leading-relaxed"
                      >
                        <span [innerHTML]="highlightUrl(source.url)"></span>
                      </div>
                      <input
                        *ngIf="source.isEditing"
                        type="text"
                        class="border border-gray-300 dark:border-zinc-600 rounded-md px-2 py-1 w-full text-xs bg-white dark:bg-zinc-800 text-gray-900 dark:text-gray-100 focus:border-blue-500 dark:focus:border-blue-400 focus:ring-1 focus:ring-blue-500 dark:focus:ring-blue-400"
                        placeholder="URL"
                        [(ngModel)]="source.url"
                        (keyup.enter)="editSource(source)"
                        (click)="$event.stopPropagation()"
                      />
                    </div>
                    <div class="flex items-center justify-between mt-1">
                      <label
                        class="relative inline-flex items-center cursor-pointer"
                      >
                        <input
                          type="checkbox"
                          class="sr-only peer"
                          [checked]="source.enabled"
                          (change)="
                            toggleSource(source); $event.stopPropagation()
                          "
                        />
                        <div
                          class="w-9 h-5 bg-gray-200 dark:bg-zinc-800 peer-focus:outline-none peer-focus:ring-1 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-zinc-800 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white dark:after:bg-gray-900 after:border-gray-300 dark:after:border-zinc-800 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600 dark:peer-checked:bg-blue-700"
                        ></div>
                      </label>
                      <div class="flex items-center gap-0.5">
                        <button
                          *ngIf="!source.isEditing"
                          (click)="
                            toggleEditMode(source); $event.stopPropagation()
                          "
                          title="Edit Source"
                          class="p-1 text-gray-500 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-100/50 dark:hover:bg-zinc-800/70 rounded-full"
                        >
                          <app-icon-lib
                            ico="edit"
                            class="h-4 w-4"
                          ></app-icon-lib>
                        </button>
                        <ng-container *ngIf="source.isEditing">
                          <button
                            (click)="
                              editSource(source); $event.stopPropagation()
                            "
                            title="Save Changes"
                            class="p-1 text-green-500 dark:text-green-400 hover:text-green-700 dark:hover:text-green-300 hover:bg-green-100/50 dark:hover:bg-green-900/70 rounded-full"
                          >
                            <app-icon-lib
                              ico="check"
                              class="h-4 w-4"
                            ></app-icon-lib>
                          </button>
                          <button
                            (click)="
                              cancelSourceEdit(source); $event.stopPropagation()
                            "
                            title="Cancel Edit"
                            class="p-1 text-gray-500 dark:text-gray-300 hover:text-gray-700 dark:hover:text-gray-100 hover:bg-gray-100/50 dark:hover:bg-zinc-800/70 rounded-full"
                          >
                            <app-icon-lib
                              ico="xMark"
                              class="h-4 w-4"
                            ></app-icon-lib>
                          </button>
                        </ng-container>
                        <button
                          (click)="
                            removeSource(source.id); $event.stopPropagation()
                          "
                          title="Delete Source"
                          class="p-1 text-gray-500 dark:text-gray-300 hover:text-red-600 dark:hover:text-red-400 hover:bg-red-100/50 dark:hover:bg-red-900/70 rounded-full"
                        >
                          <app-icon-lib
                            ico="trash"
                            class="h-4 w-4"
                          ></app-icon-lib>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </td>

              <!-- Desktop View Cells -->
              <td
                class="hidden lg:table-cell p-1 sm:p-2 w-10 text-gray-400 align-middle text-center"
              >
                <div
                  cdkDragHandle
                  class="cursor-move p-2 hover:bg-gray-200 dark:hover:bg-zinc-700 rounded-md inline-block"
                >
                  <app-icon-lib ico="menu" class="h-5 w-5"></app-icon-lib>
                </div>
              </td>
              <td
                class="hidden lg:table-cell p-3 w-12 text-center align-middle"
              >
                <input
                  type="checkbox"
                  class="w-5 h-5 text-blue-600 border-gray-300 dark:border-zinc-600 rounded focus:ring-offset-0 focus:ring-2 focus:ring-blue-400 dark:focus:ring-blue-700"
                  [attr.aria-label]="
                    'Select source ' + (source.name || getDisplayName(source))
                  "
                  [(ngModel)]="source.selected"
                  (ngModelChange)="onRowSelectionChange()"
                  (click)="$event.stopPropagation()"
                />
              </td>
              <td class="hidden lg:table-cell p-3 align-middle min-w-[150px]">
                <div class="flex items-center gap-3">
                  <img
                    src="https://www.google.com/s2/favicons?sz=32&domain_url={{
                      getDisplayName(source)
                    }}"
                    class="w-8 h-8 rounded-full flex-shrink-0 object-contain border border-gray-200 dark:border-zinc-700"
                    alt="Favicon"
                    loading="lazy"
                  />
                  <div class="flex-1 min-w-0">
                    <div
                      *ngIf="!source.isEditing"
                      class="text-sm font-medium text-gray-800 dark:text-gray-100 break-words"
                    >
                      {{ source.name || getDisplayName(source) }}
                    </div>
                    <input
                      *ngIf="source.isEditing"
                      name="name"
                      type="text"
                      class="border-2 border-gray-300 dark:border-zinc-600 rounded-md p-2 w-full text-sm bg-white dark:bg-zinc-800 text-gray-900 dark:text-gray-100 focus:border-blue-500 dark:focus:border-blue-400 focus:ring-1 focus:ring-blue-500 dark:focus:ring-blue-400 max-w-full"
                      placeholder="Enter name"
                      [(ngModel)]="source.name"
                      (keyup.enter)="editSource(source)"
                      (click)="$event.stopPropagation()"
                    />
                  </div>
                </div>
              </td>
              <td class="hidden lg:table-cell p-3 align-middle min-w-[200px]">
                <div class="max-w-full">
                  <div
                    *ngIf="!source.isEditing"
                    class="text-sm text-gray-800 dark:text-gray-100 break-words leading-relaxed"
                    [innerHTML]="highlightUrl(source.url || 'No URL provided')"
                  ></div>
                  <input
                    *ngIf="source.isEditing"
                    name="url"
                    type="text"
                    class="border-2 border-gray-300 dark:border-zinc-600 rounded-md p-2 w-full text-sm bg-white dark:bg-zinc-800 text-gray-900 dark:text-gray-100 focus:border-blue-500 dark:focus:border-blue-400 focus:ring-1 focus:ring-blue-500 dark:focus:ring-blue-400 max-w-full"
                    placeholder="Enter URL"
                    [(ngModel)]="source.url"
                    (keyup.enter)="editSource(source)"
                    (click)="$event.stopPropagation()"
                  />
                </div>
              </td>
              <td
                class="hidden lg:table-cell p-3 text-center align-middle w-24"
              >
                <label class="relative inline-flex items-center cursor-pointer">
                  <input
                    type="checkbox"
                    class="sr-only peer"
                    [checked]="source.enabled"
                    (change)="toggleSource(source); $event.stopPropagation()"
                  />
                  <div
                    class="w-11 h-6 bg-gray-200 dark:bg-zinc-800 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-zinc-800 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white dark:after:bg-gray-900 after:border-gray-300 dark:after:border-zinc-800 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600 dark:peer-checked:bg-blue-700"
                  ></div>
                </label>
              </td>
              <td class="hidden lg:table-cell p-3 text-right align-middle w-32">
                <div class="flex items-center justify-end gap-1">
                  <button
                    *ngIf="!source.isEditing"
                    (click)="toggleEditMode(source); $event.stopPropagation()"
                    title="Edit Source"
                    class="p-1.5 text-gray-500 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900 rounded-full"
                  >
                    <app-icon-lib ico="edit" class="h-5 w-5"></app-icon-lib>
                  </button>
                  <ng-container *ngIf="source.isEditing">
                    <button
                      (click)="editSource(source); $event.stopPropagation()"
                      title="Save Changes"
                      class="p-1.5 text-green-500 dark:text-green-400 hover:text-green-700 dark:hover:text-green-300 hover:bg-green-100 dark:hover:bg-green-900 rounded-full"
                    >
                      <app-icon-lib ico="check" class="h-5 w-5"></app-icon-lib>
                    </button>
                    <button
                      (click)="
                        cancelSourceEdit(source); $event.stopPropagation()
                      "
                      title="Cancel Edit"
                      class="p-1.5 text-gray-500 dark:text-gray-300 hover:text-gray-700 dark:hover:text-gray-100 hover:bg-gray-100 dark:hover:bg-zinc-800 rounded-full"
                    >
                      <app-icon-lib ico="close" class="h-5 w-5"></app-icon-lib>
                    </button>
                  </ng-container>
                  <button
                    (click)="removeSource(source.id); $event.stopPropagation()"
                    title="Delete Source"
                    class="p-1.5 text-gray-500 dark:text-gray-300 hover:text-red-600 dark:hover:text-red-400 hover:bg-red-100 dark:hover:bg-red-900 rounded-full"
                  >
                    <app-icon-lib ico="trash" class="h-5 w-5"></app-icon-lib>
                  </button>
                </div>
              </td>
            </tr>
          </ng-container>
          <ng-template #noResultsOrEmpty>
            <tr>
              <td
                colspan="6"
                class="text-center p-8 text-gray-500 dark:text-gray-400"
              >
                <div *ngIf="sources.length === 0 && !searchInput.trim()">
                  No sources yet. Click "Add New" to get started!
                </div>
                <div *ngIf="sources.length > 0 && searchInput.trim()">
                  No sources match your filter "{{ searchInput }}".
                </div>
              </td>
            </tr>
          </ng-template>
        </tbody>
      </table>
    </div>

    <div
      class="mt-6 mb-18 text-center text-xs text-gray-500 dark:text-gray-400"
    >
      <p>
        Note: Data are being stored on your browser's local storage. This means
        that all data will be lost if you clear your browser's local storage or
        use a different browser.
      </p>
    </div>
  </div>

  <!-- Floating Save/Discard Bar -->
  <div
    *ngIf="hasUnsavedChanges"
    class="fixed bottom-0 left-0 right-0 bg-white dark:bg-zinc-900 p-3 sm:p-4 border-t border-gray-200 dark:border-zinc-700 z-50"
  >
    <div
      class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-3 sm:gap-4"
    >
      <p class="text-sm text-gray-700 dark:text-gray-100 flex-grow">
        You have unsaved changes.
      </p>
      <div class="flex gap-2 w-full sm:w-auto">
        <button
          (click)="isUniversalOpenDiscard = true"
          [disabled]="isSaving"
          class="cursor-pointer px-4 py-2 text-sm font-medium rounded-lg flex items-center justify-center gap-2 transition-colors bg-gray-100 dark:bg-zinc-800 text-gray-700 dark:text-gray-100 hover:bg-gray-200 dark:hover:bg-zinc-700 border border-gray-300 dark:border-zinc-600 focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 disabled:opacity-60 w-1/2 sm:w-auto"
        >
          <app-icon-lib ico="trash" class="h-5 w-5"></app-icon-lib>
          <!-- Assuming you have an xMark or similar icon -->
          Discard
        </button>
        <button
          (click)="saveData()"
          [disabled]="isSaving"
          class="cursor-pointer px-4 py-2 text-sm font-medium rounded-lg flex items-center justify-center gap-2 transition-colors bg-blue-600 dark:bg-blue-700 text-white hover:bg-blue-700 dark:hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-400 dark:focus:ring-blue-700 disabled:opacity-60 w-1/2 sm:w-auto"
        >
          <app-icon-lib
            *ngIf="!isSaving"
            ico="save"
            class="h-5 w-5"
          ></app-icon-lib>
          <app-icon-lib
            *ngIf="isSaving"
            ico="spinner"
            class="w-5 h-5 animate-spin"
          ></app-icon-lib>
          {{ isSaving ? "Saving..." : "Save Changes" }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<!-- Advanced Source Modal -->
<div
  *ngIf="isAdvancedSourceModalOpen"
  class="fixed inset-0 z-50 flex items-start sm:items-center justify-center p-2 sm:p-4 bg-black/20 dark:bg-black/60 backdrop-blur-sm overflow-y-auto"
  (click)="closeAdvancedSourceModal()"
>
  <div
    class="bg-white dark:bg-zinc-900 rounded-xl border border-gray-200 dark:border-zinc-700 shadow-2xl w-full max-w-4xl my-4 sm:my-8 max-h-[95vh] sm:max-h-[85vh] overflow-hidden flex flex-col"
    (click)="$event.stopPropagation()"
  >
    <!-- Modal Header -->
    <div
      class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-zinc-700 bg-gray-50 dark:bg-zinc-800 rounded-t-xl"
    >
      <div class="flex items-center gap-3">
        <div class="w-2 h-8 bg-purple-500 rounded-full"></div>
        <div>
          <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">
            Advanced Source Editor
          </h2>
          <div class="text-sm text-gray-500 dark:text-gray-400">
            Create sources with URL tags and live validation
          </div>
        </div>
      </div>
      <button
        (click)="closeAdvancedSourceModal()"
        class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-zinc-700 transition-colors"
        title="Close"
      >
        <app-icon-lib
          ico="xMark"
          class="w-5 h-5 text-gray-600 dark:text-gray-300"
        ></app-icon-lib>
      </button>
    </div>

    <!-- Modal Content -->
    <div class="flex-1 overflow-y-auto p-4 sm:p-6 space-y-4 sm:space-y-6">
      <!-- Source Name Input -->
      <div>
        <label
          class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2"
        >
          Source Name (optional)
        </label>
        <input
          type="text"
          class="w-full px-4 py-2 border border-gray-300 dark:border-zinc-600 rounded-lg bg-white dark:bg-zinc-800 text-gray-900 dark:text-gray-100 focus:border-purple-500 dark:focus:border-purple-700 focus:ring-2 focus:ring-purple-200 dark:focus:ring-purple-900 transition-all"
          placeholder="Enter a friendly name for this source"
          [(ngModel)]="advancedSourceName"
        />
      </div>

      <!-- URL Textarea -->
      <div>
        <label
          class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2"
        >
          Source URL with Tags
        </label>
        <textarea
          id="advancedSourceTextarea"
          rows="4"
          class="w-full px-4 py-2 border border-gray-300 dark:border-zinc-600 rounded-lg bg-white dark:bg-zinc-800 text-gray-900 dark:text-gray-100 focus:border-purple-500 dark:focus:border-purple-700 focus:ring-2 focus:ring-purple-200 dark:focus:ring-purple-900 transition-all resize-none font-mono text-sm"
          placeholder="https://example.com/embed/#type/#id/#season/#episode"
          [(ngModel)]="advancedSourceUrl"
          (input)="validateAdvancedUrl()"
        ></textarea>
      </div>

      <!-- Tag Buttons -->
      <div>
        <label
          class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-3"
        >
          Click to insert tags at cursor position
        </label>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
          <button
            type="button"
            class="px-4 py-2 text-sm font-medium rounded-lg border transition-all flex items-center justify-center gap-2"
            [ngClass]="{
              'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 border-blue-300 dark:border-blue-700':
                validationState.hasId,
              'bg-gray-100 dark:bg-zinc-800 text-gray-700 dark:text-gray-100 border-gray-300 dark:border-zinc-600 hover:bg-gray-200 dark:hover:bg-zinc-700':
                !validationState.hasId
            }"
            (click)="insertTag('#id')"
            title="TMDB ID placeholder"
          >
            <app-icon-lib
              ico="check"
              class="w-4 h-4"
              *ngIf="validationState.hasId"
            ></app-icon-lib>
            #id
          </button>

          <button
            type="button"
            class="px-4 py-2 text-sm font-medium rounded-lg border transition-all flex items-center justify-center gap-2"
            [ngClass]="{
              'bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300 border-orange-300 dark:border-orange-700':
                validationState.hasType,
              'bg-gray-100 dark:bg-zinc-800 text-gray-700 dark:text-gray-100 border-gray-300 dark:border-zinc-600 hover:bg-gray-200 dark:hover:bg-zinc-700':
                !validationState.hasType
            }"
            (click)="insertTag('#type')"
            title="Media type (tv/movie) placeholder"
          >
            <app-icon-lib
              ico="check"
              class="w-4 h-4"
              *ngIf="validationState.hasType"
            ></app-icon-lib>
            #type
          </button>

          <button
            type="button"
            class="px-4 py-2 text-sm font-medium rounded-lg border transition-all flex items-center justify-center gap-2"
            [ngClass]="{
              'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 border-red-300 dark:border-red-700':
                validationState.hasSeason,
              'bg-gray-100 dark:bg-zinc-800 text-gray-700 dark:text-gray-100 border-gray-300 dark:border-zinc-600 hover:bg-gray-200 dark:hover:bg-zinc-700':
                !validationState.hasSeason
            }"
            (click)="insertTag('#season')"
            title="Season number placeholder"
          >
            <app-icon-lib
              ico="check"
              class="w-4 h-4"
              *ngIf="validationState.hasSeason"
            ></app-icon-lib>
            #season
          </button>

          <button
            type="button"
            class="px-4 py-2 text-sm font-medium rounded-lg border transition-all flex items-center justify-center gap-2"
            [ngClass]="{
              'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 border-green-300 dark:border-green-700':
                validationState.hasEpisode,
              'bg-gray-100 dark:bg-zinc-800 text-gray-700 dark:text-gray-100 border-gray-300 dark:border-zinc-600 hover:bg-gray-200 dark:hover:bg-zinc-700':
                !validationState.hasEpisode
            }"
            (click)="insertTag('#episode')"
            title="Episode number placeholder"
          >
            <app-icon-lib
              ico="check"
              class="w-4 h-4"
              *ngIf="validationState.hasEpisode"
            ></app-icon-lib>
            #episode
          </button>
        </div>
      </div>

      <!-- Live Validation Status -->
      <div
        class="bg-gray-50 dark:bg-zinc-800 rounded-lg p-4 border border-gray-200 dark:border-zinc-700"
      >
        <div class="flex items-center gap-2 mb-2">
          <app-icon-lib
            ico="check"
            class="w-5 h-5 text-green-500 dark:text-green-300"
            *ngIf="validationState.isValid"
          ></app-icon-lib>
          <app-icon-lib
            ico="close"
            class="w-5 h-5 text-red-500 dark:text-red-300"
            *ngIf="!validationState.isValid"
          ></app-icon-lib>
          <span
            class="font-medium text-sm"
            [ngClass]="{
              'text-green-700 dark:text-green-300': validationState.isValid,
              'text-red-700 dark:text-red-300': !validationState.isValid
            }"
          >
            {{
              validationState.isValid
                ? "All required tags present!"
                : "Missing required tags"
            }}
          </span>
        </div>
        <div class="text-xs text-gray-600 dark:text-gray-400 space-y-1">
          <div class="flex items-center gap-2">
            <span
              class="w-2 h-2 rounded-full"
              [ngClass]="{
                'bg-blue-500 dark:bg-blue-400': validationState.hasId,
                'bg-gray-300 dark:bg-zinc-800': !validationState.hasId
              }"
            ></span>
            <span>#id tag</span>
          </div>
          <div class="flex items-center gap-2">
            <span
              class="w-2 h-2 rounded-full"
              [ngClass]="{
                'bg-orange-500 dark:bg-orange-400': validationState.hasType,
                'bg-gray-300 dark:bg-zinc-800': !validationState.hasType
              }"
            ></span>
            <span>#type tag</span>
          </div>
          <div class="flex items-center gap-2">
            <span
              class="w-2 h-2 rounded-full"
              [ngClass]="{
                'bg-red-500 dark:bg-red-400': validationState.hasSeason,
                'bg-gray-300 dark:bg-zinc-800': !validationState.hasSeason
              }"
            ></span>
            <span>#season tag</span>
          </div>
          <div class="flex items-center gap-2">
            <span
              class="w-2 h-2 rounded-full"
              [ngClass]="{
                'bg-green-500 dark:bg-green-400': validationState.hasEpisode,
                'bg-gray-300 dark:bg-zinc-800': !validationState.hasEpisode
              }"
            ></span>
            <span>#episode tag</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Footer -->
    <div
      class="flex flex-col sm:flex-row justify-end gap-3 p-4 sm:p-6 border-t border-gray-200 dark:border-zinc-700 bg-gray-50 dark:bg-zinc-800 rounded-b-xl"
    >
      <button
        type="button"
        class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-100 bg-white dark:bg-zinc-800 rounded-lg border border-gray-300 dark:border-zinc-600 hover:bg-gray-50 dark:hover:bg-zinc-700 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-600 order-2 sm:order-1"
        (click)="closeAdvancedSourceModal()"
      >
        Cancel
      </button>
      <button
        type="button"
        class="px-4 py-2 text-sm font-medium text-white rounded-lg border transition-colors focus:outline-none focus:ring-2 focus:ring-purple-400 dark:focus:ring-purple-700 disabled:opacity-50 disabled:cursor-not-allowed order-1 sm:order-2"
        [ngClass]="{
          'bg-purple-600 dark:bg-purple-700 hover:bg-purple-700 dark:hover:bg-purple-800 border-purple-600 dark:border-purple-700':
            advancedSourceUrl.trim(),
          'bg-gray-400 dark:bg-zinc-800 border-gray-400 dark:border-zinc-700':
            !advancedSourceUrl.trim()
        }"
        (click)="confirmAdvancedAdd()"
        [disabled]="!advancedSourceUrl.trim()"
      >
        Add Source
      </button>
    </div>
  </div>
</div>

<universal-modal
  [open]="isUniversalOpenDelete"
  [title]="YnTitleDelete"
  [message]="YnMessageDelete"
  (confirm)="handleUniversalConfirmDelete()"
  (cancel)="isUniversalOpenDelete = false"
></universal-modal>

<universal-modal
  [open]="isUniversalOpenDiscard"
  [title]="YnTitleDiscard"
  [message]="YnMessageDiscard"
  (confirm)="handleUniversalConfirmDiscard()"
  (cancel)="isUniversalOpenDiscard = false"
></universal-modal>

<app-export
  [isExportModalOpen]="isExportModalOpen"
  [sources]="sources"
  (isExportModalOpenChange)="onExportModalChange($event)"
></app-export>

<app-import
  [isImportModalOpen]="isImportModalOpen"
  [sources]="sources"
  (isImportModalOpenChange)="onImportModalChange($event)"
></app-import>

<universal-modal
  [open]="showSubscribeWarningModal"
  title="Subscribe to Capi sources?"
  message="You have custom sources. Subscribing will remove them. Continue?"
  [confirmLabel]="'Subscribe & Replace'"
  [cancelLabel]="'Cancel'"
  (confirm)="handleSubscribeConfirm()"
  (cancel)="handleSubscribeCancel()"
></universal-modal>
